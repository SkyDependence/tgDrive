import{_ as e}from"./_plugin-vue_export-helper-Bm9C0Znx.js";/* empty css               */import"./el-tooltip-l0sNRNKZ.js";/* empty css                  *//* empty css                 *//* empty css                */import"./el-collapse-transition-l0sNRNKZ.js";/* empty css                  *//* empty css                        *//* empty css                 */import{d as a,r as l,j as s,f as t,y as n,c as o,P as i,H as r,au as u,o as c,a as d,u as p,R as m,O as v,Q as g,aa as f,M as h,G as k}from"./vue-vendor-B9yd_xiB.js";import{a as w}from"./vendor-BVvGM7bJ.js";import{a as T,b as _,u as y,d as C,e as x,c as b,t as j,f as N,h as z,i as M,j as $,k as L,l as B,m as F,n as q,o as U,p as V,q as D,r as E,v as O,s as R,w as I,x as P,y as S}from"./element-plus-BmgivntE.js";const G={class:"page-container"},A={class:"card-header"},H={key:0,class:"file-queue-section"},J={class:"queue-header"},K={class:"queue-actions"},Q={class:"file-queue-list"},W={class:"file-preview"},X=["src"],Y={class:"file-details"},Z={class:"file-name-input"},ee={class:"file-meta"},ae={class:"file-actions"},le={class:"upload-actions"},se={key:0,class:"progress-section"},te={class:"file-name"},ne={class:"file-size-info"},oe={key:0,class:"telegram-info"},ie={class:"telegram-progress-text"},re={key:0},ue={key:1},ce={class:"card-header"},de={key:0,class:"empty-state"},pe={key:1,class:"uploaded-files-list"},me={class:"file-details"},ve={class:"uploaded-file-name"},ge={class:"file-actions"},fe={key:2,class:"batch-actions"},he=e(a({__name:"UploadPage",setup(e){const a=u(),he=l(),ke=l([]),we=l([]),Te=l(!1),_e=l([]),ye=l(null),Ce=l(!1),xe=s(()=>_e.value.filter(e=>"success"===e.status).length),be=(e,a)=>{a.forEach(e=>{e.customName||(e.customName=e.name)}),ke.value=a},je=(e,a)=>{ke.value=a},Ne=()=>{var e;ke.value=[],null==(e=he.value)||e.clearFiles(),T.success("队列已清空")},ze=e=>!!e.raw&&["image/jpeg","image/png","image/gif","image/webp","image/svg+xml"].includes(e.raw.type),Me=e=>e.raw&&ze(e)?URL.createObjectURL(e.raw):"",$e=async()=>{var e,a,l;if(0!==ke.value.length){Te.value=!0,we.value=[],_e.value=ke.value.map(e=>({uid:e.uid,name:e.name,percentage:0,status:void 0,loaded:0,total:e.size||0,serverToTelegram:{percentage:0,currentChunk:0,totalChunks:0,status:"waiting"}}));for(const l of ke.value){const t=_e.value.find(e=>e.uid===l.uid);if(!t)continue;const n=l.raw;try{const e=new FormData,a=l.customName&&l.customName.trim()?l.customName.trim():l.name,s=new File([n],a,{type:n.type});e.append("file",s);const o=await w.post("/api/upload",e,{timeout:216e5,onUploadProgress:e=>{if(e.total){t.loaded=e.loaded,t.total=e.total;const a=Math.round(e.loaded/e.total*1e4)/100;t.percentage=a}}}),{code:i,msg:r,data:u}=o.data;1===i?(t.serverToTelegram.status="uploading",we.value.push(u)):(t.status="exception",T.error(`${l.name} 上传失败: ${r||"未知错误"}`))}catch(s){t.status="exception";const n=(null==(a=null==(e=s.response)?void 0:e.data)?void 0:a.msg)||s.message||"网络错误";T.error(`${l.name} 上传失败: ${n}`)}}Te.value=!1,ke.value=[],null==(l=he.value)||l.clearFiles()}else T.warning("请先选择文件")},Le=()=>{a.push("/fileList")},Be=(e,a)=>{navigator.clipboard.writeText(e).then(()=>{T.success(a)}).catch(e=>{T.error("复制失败: "+e)})},Fe=()=>{const e=we.value.map(e=>`[${e.fileName}](${e.downloadLink})`).join("\n");Be(e,`已批量复制 ${we.value.length} 个 Markdown 链接`)},qe=()=>{const e=we.value.map(e=>e.downloadLink).join("\n");Be(e,`已批量复制 ${we.value.length} 个下载链接`)},Ue=e=>{if(0===e)return"0 B";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["B","KB","MB","GB","TB"][a]},Ve=e=>{var a;const l=null==(a=e.clipboardData)?void 0:a.items;if(l){for(let e=0;e<l.length;e++)if("file"===l[e].kind){const a=l[e].getAsFile();if(a){const l=Date.now()+e,s={name:a.name,size:a.size,uid:l,raw:Object.assign(a,{uid:l}),status:"ready"};ke.value.some(e=>e.name===s.name&&e.size===s.size)||ke.value.push(s)}}ke.value.length>0&&T.success("已通过粘贴添加文件")}};return t(()=>{window.addEventListener("paste",Ve),(()=>{const e=`ws://${window.location.host}/ws/upload-progress`;ye.value=new WebSocket(e),ye.value.onmessage=e=>{try{const a=JSON.parse(e.data);if("upload_progress"===a.type){const e=_e.value.find(e=>e.name===a.fileName);e&&"completed"!==e.serverToTelegram.status&&("waiting"===e.serverToTelegram.status&&(e.serverToTelegram.status="uploading"),e.serverToTelegram.percentage=Math.round(100*a.percentage)/100,void 0!==a.currentChunk&&(e.serverToTelegram.currentChunk=a.currentChunk),void 0!==a.totalChunks&&(e.serverToTelegram.totalChunks=a.totalChunks),e.percentage=Math.round(100*a.percentage)/100)}else if("upload_complete"===a.type){const e=_e.value.find(e=>e.name===a.fileName);e&&(e.serverToTelegram.status="completed",e.serverToTelegram.percentage=100,e.status="success",e.percentage=100,T.success(`${a.fileName} 完全上传完成`))}else if("upload_error"===a.type){const e=_e.value.find(e=>e.name===a.fileName);e&&(e.status="exception",e.serverToTelegram.status="error"),T.error(`${a.fileName} 传输到Telegram失败: ${a.error}`)}}catch(a){}},ye.value.onerror=e=>{}})()}),n(()=>{window.removeEventListener("paste",Ve),ye.value&&(ye.value.close(),ye.value=null)}),(e,a)=>{const l=N,s=z,t=M,n=R,u=I,w=P,T=$,ye=L,Ve=B,De=F,Ee=S,Oe=_;return c(),o("div",G,[i(Oe,{gutter:20},{default:r(()=>[i(Ve,{xs:24,sm:24,md:14,lg:14,xl:14},{default:r(()=>[i(ye,{class:"content-card"},{header:r(()=>[d("div",A,[i(l,null,{default:r(()=>[i(p(y))]),_:1}),a[1]||(a[1]=d("span",null,"文件上传",-1))])]),default:r(()=>[i(s,{ref_key:"uploadRef",ref:he,drag:"",multiple:"",action:"#","auto-upload":!1,"on-change":be,"on-remove":je,"file-list":ke.value,class:"upload-dragger"},{tip:r(()=>a[2]||(a[2]=[d("div",{class:"el-upload__tip"}," 支持多文件上传，支持 Ctrl+V 粘贴文件。 ",-1)])),default:r(()=>[i(l,{class:"el-icon--upload"},{default:r(()=>[i(p(y))]),_:1}),a[3]||(a[3]=d("div",{class:"el-upload__text"},[m(" 将文件拖到此处, 或 "),d("em",null,"点击选择")],-1))]),_:1},8,["file-list"]),ke.value.length>0?(c(),o("div",H,[d("div",J,[d("h3",null,"上传队列 ("+v(ke.value.length)+" 个文件)",1),d("div",K,[i(t,{size:"small",onClick:Ne,icon:p(C),plain:""},{default:r(()=>a[4]||(a[4]=[m("清空队列")])),_:1},8,["icon"]),i(t,{size:"small",onClick:a[0]||(a[0]=e=>Ce.value=!0),icon:p(x),plain:""},{default:r(()=>a[5]||(a[5]=[m("批量重命名")])),_:1},8,["icon"])])]),d("div",Q,[(c(!0),o(g,null,f(ke.value,(e,s)=>{return c(),o("div",{key:e.uid,class:"queue-file-item"},[d("div",W,[ze(e)?(c(),o("img",{key:0,src:Me(e),class:"file-thumbnail"},null,8,X)):(c(),k(l,{key:1,class:"file-icon-large"},{default:r(()=>[i(p(q))]),_:1}))]),d("div",Y,[d("div",Z,[i(n,{modelValue:e.customName,"onUpdate:modelValue":a=>e.customName=a,placeholder:e.name,size:"small",onBlur:a=>(e=>{e.customName&&e.customName.trim()||(e.customName=e.name)})(e)},{prepend:r(()=>a[6]||(a[6]=[m("名称")])),_:2},1032,["modelValue","onUpdate:modelValue","placeholder","onBlur"])]),d("div",ee,[d("span",null,"大小: "+v(Ue(e.size||0)),1),d("span",null,"类型: "+v((g=e.name,{jpg:"图片",jpeg:"图片",png:"图片",gif:"图片",webp:"图片",pdf:"文档",doc:"文档",docx:"文档",xls:"表格",xlsx:"表格",mp4:"视频",avi:"视频",mov:"视频",wmv:"视频",mp3:"音频",wav:"音频",flac:"音频",zip:"压缩包",rar:"压缩包","7z":"压缩包"}[(null==(f=g.split(".").pop())?void 0:f.toLowerCase())||""]||"其他")),1)])]),d("div",ae,[i(u,null,{default:r(()=>[i(t,{size:"small",onClick:e=>(e=>{if(e>0){const a=ke.value[e];ke.value[e]=ke.value[e-1],ke.value[e-1]=a}})(s),disabled:0===s,icon:p(U),circle:""},null,8,["onClick","disabled","icon"]),i(t,{size:"small",onClick:e=>(e=>{if(e<ke.value.length-1){const a=ke.value[e];ke.value[e]=ke.value[e+1],ke.value[e+1]=a}})(s),disabled:s===ke.value.length-1,icon:p(V),circle:""},null,8,["onClick","disabled","icon"]),i(t,{size:"small",onClick:a=>(e=>{var a;const l=ke.value.findIndex(a=>a.uid===e.uid);l>-1&&(ke.value.splice(l,1),null==(a=he.value)||a.clearFiles(),ke.value.forEach(e=>{var a;null==(a=he.value)||a.handleStart(e.raw)}))})(e),type:"danger",icon:p(C),circle:""},null,8,["onClick","icon"])]),_:2},1024)])]);var g,f}),128))])])):h("",!0),d("div",le,[i(t,{type:"primary",onClick:$e,disabled:Te.value||0===ke.value.length,loading:Te.value,size:"large",icon:p(b)},{default:r(()=>[m(v(Te.value?`正在上传 (${xe.value}/${ke.value.length})`:"开始上传"),1)]),_:1},8,["disabled","loading","icon"])]),i(T,null,{default:r(()=>[_e.value.length>0?(c(),o("div",se,[(c(!0),o(g,null,f(_e.value,e=>(c(),o("div",{key:e.uid,class:"file-progress-item"},[d("span",te,v(e.name),1),i(w,{percentage:Math.round(100*e.percentage)/100,status:e.status,"stroke-width":8,striped:"","striped-flow":"success"!==e.status&&"exception"!==e.status},null,8,["percentage","status","striped-flow"]),d("div",ne,v(Ue(e.loaded))+" / "+v(Ue(e.total)),1),"uploading"===e.serverToTelegram.status||"completed"===e.serverToTelegram.status?(c(),o("div",oe,[d("div",ie,["completed"===e.serverToTelegram.status?(c(),o("span",re,"✅ 已传输到Telegram")):(c(),o("span",ue," 传输到Telegram: "+v(e.serverToTelegram.currentChunk||0)+"/"+v(e.serverToTelegram.totalChunks||0)+" 片 ("+v(Math.round(100*e.serverToTelegram.percentage)/100)+"%) ",1))]),i(w,{percentage:Math.round(100*e.serverToTelegram.percentage)/100,status:"completed"===e.serverToTelegram.status?"success":e.status,"stroke-width":8,striped:"","striped-flow":"completed"!==e.serverToTelegram.status&&"exception"!==e.status},null,8,["percentage","status","striped-flow"])])):h("",!0)]))),128))])):h("",!0)]),_:1})]),_:1})]),_:1}),i(Ve,{xs:24,sm:24,md:10,lg:10,xl:10},{default:r(()=>[i(ye,{class:"content-card"},{header:r(()=>[d("div",ce,[i(l,null,{default:r(()=>[i(p(j))]),_:1}),a[8]||(a[8]=d("span",null,"本次上传结果",-1)),i(t,{text:"",type:"primary",onClick:Le},{default:r(()=>a[7]||(a[7]=[m("查看全部")])),_:1})])]),default:r(()=>[0===we.value.length?(c(),o("div",de,[i(De,{description:"暂无上传成功的文件"})])):(c(),o("div",pe,[(c(!0),o(g,null,f(we.value,e=>(c(),o("div",{key:e.fileId,class:"uploaded-file-item"},[d("div",me,[i(l,null,{default:r(()=>[i(p(q))]),_:1}),d("span",ve,v(e.fileName),1)]),d("div",ge,[i(Ee,{content:"复制 Markdown 格式",placement:"top"},{default:r(()=>[i(t,{text:"",circle:"",icon:p(D),onClick:a=>(e=>{Be(`[${e.fileName}](${e.downloadLink})`,"Markdown 格式已复制")})(e)},null,8,["icon","onClick"])]),_:2},1024),i(Ee,{content:"复制下载链接",placement:"top"},{default:r(()=>[i(t,{text:"",circle:"",icon:p(E),onClick:a=>(e=>{Be(e.downloadLink,"下载链接已复制")})(e)},null,8,["icon","onClick"])]),_:2},1024),i(Ee,{content:"打开/下载文件",placement:"top"},{default:r(()=>[i(t,{text:"",circle:"",icon:p(O),onClick:a=>{return l=e.downloadLink,void window.open(l,"_blank");var l}},null,8,["icon","onClick"])]),_:2},1024)])]))),128))])),we.value.length>0?(c(),o("div",fe,[i(t,{onClick:Fe,disabled:0===we.value.length,size:"small",plain:""},{default:r(()=>a[9]||(a[9]=[m("批量复制 (MD)")])),_:1},8,["disabled"]),i(t,{onClick:qe,disabled:0===we.value.length,size:"small",plain:""},{default:r(()=>a[10]||(a[10]=[m("批量复制 (链接)")])),_:1},8,["disabled"])])):h("",!0)]),_:1})]),_:1})]),_:1})])}}}),[["__scopeId","data-v-65bea967"]]);export{he as default};

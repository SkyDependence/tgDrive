import{_ as e}from"./_plugin-vue_export-helper-DvehuVrX.js";/* empty css                               */import"./el-tooltip-l0sNRNKZ.js";/* empty css                  *//* empty css                 *//* empty css                *//* empty css                  */import{d as a,r as l,b as s,l as t,U as o,c as n,M as r,E as i,o as u,av as d,a as c,u as p,J as v,K as m,H as g,L as f,a9 as h}from"./vue-vendor-CxLOoai_.js";import{a as k}from"./vendor-CPGCUlN1.js";import{a as T,b as _,c as w,d as y,e as C,f as x,u as M,h as $,i as j,j as b,k as z,l as L,m as N,n as B,o as F,p as D,v as E,t as U}from"./element-plus-DQjCWvVU.js";const I={class:"page-container"},J={class:"card-header"},K={class:"upload-actions"},O={key:0,class:"progress-section"},P={class:"file-name"},S={class:"file-size-info"},A={key:0,class:"telegram-info"},G={class:"telegram-progress-text"},H={key:0},R={key:1},V={class:"card-header"},W={key:0,class:"empty-state"},q={key:1,class:"uploaded-files-list"},Q={class:"file-details"},X={class:"uploaded-file-name"},Y={class:"file-actions"},Z={key:2,class:"batch-actions"},ee=e(a({__name:"UploadPage",setup(e){const a=d(),ee=l(),ae=l([]),le=l([]),se=l(!1),te=l([]),oe=l(null),ne=s(()=>te.value.filter(e=>"success"===e.status).length),re=(e,a)=>{ae.value=a},ie=(e,a)=>{ae.value=a},ue=async()=>{var e,a,l;if(0!==ae.value.length){se.value=!0,le.value=[],te.value=ae.value.map(e=>({uid:e.uid,name:e.name,percentage:0,status:void 0,loaded:0,total:e.size||0,serverToTelegram:{percentage:0,currentChunk:0,totalChunks:0,status:"waiting"}}));for(const l of ae.value){const t=te.value.find(e=>e.uid===l.uid);if(!t)continue;const o=l.raw;try{const e=new FormData;e.append("file",o);const a=await k.post("/api/upload",e,{timeout:216e5,onUploadProgress:e=>{if(e.total){t.loaded=e.loaded,t.total=e.total;const a=Math.round(e.loaded/e.total*1e4)/100;t.percentage=a}}}),{code:s,msg:n,data:r}=a.data;1===s?(t.serverToTelegram.status="uploading",le.value.push(r)):(t.status="exception",_.error(`${l.name} 上传失败: ${n||"未知错误"}`))}catch(s){t.status="exception";const o=(null==(a=null==(e=s.response)?void 0:e.data)?void 0:a.msg)||s.message||"网络错误";_.error(`${l.name} 上传失败: ${o}`)}}se.value=!1,ae.value=[],null==(l=ee.value)||l.clearFiles()}else _.warning("请先选择文件")},de=()=>{a.push("/fileList")},ce=(e,a)=>{navigator.clipboard.writeText(e).then(()=>{_.success(a)}).catch(e=>{_.error("复制失败: "+e)})},pe=()=>{const e=le.value.map(e=>`[${e.fileName}](${e.downloadLink})`).join("\n");ce(e,`已批量复制 ${le.value.length} 个 Markdown 链接`)},ve=()=>{const e=le.value.map(e=>e.downloadLink).join("\n");ce(e,`已批量复制 ${le.value.length} 个下载链接`)},me=e=>{if(0===e)return"0 B";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["B","KB","MB","GB","TB"][a]},ge=e=>{var a;const l=null==(a=e.clipboardData)?void 0:a.items;if(l){for(let e=0;e<l.length;e++)if("file"===l[e].kind){const a=l[e].getAsFile();if(a){const l=Date.now()+e,s={name:a.name,size:a.size,uid:l,raw:Object.assign(a,{uid:l}),status:"ready"};ae.value.some(e=>e.name===s.name&&e.size===s.size)||ae.value.push(s)}}ae.value.length>0&&_.success("已通过粘贴添加文件")}};return t(()=>{window.addEventListener("paste",ge),(()=>{const e=`ws://${window.location.host}/ws/upload-progress`;oe.value=new WebSocket(e),oe.value.onmessage=e=>{try{const a=JSON.parse(e.data);if("upload_progress"===a.type){const e=te.value.find(e=>e.name===a.fileName);e&&"completed"!==e.serverToTelegram.status&&("waiting"===e.serverToTelegram.status&&(e.serverToTelegram.status="uploading"),e.serverToTelegram.percentage=Math.round(100*a.percentage)/100,void 0!==a.currentChunk&&(e.serverToTelegram.currentChunk=a.currentChunk),void 0!==a.totalChunks&&(e.serverToTelegram.totalChunks=a.totalChunks),e.percentage=Math.round(100*a.percentage)/100)}else if("upload_complete"===a.type){const e=te.value.find(e=>e.name===a.fileName);e&&(e.serverToTelegram.status="completed",e.serverToTelegram.percentage=100,e.status="success",e.percentage=100,_.success(`${a.fileName} 完全上传完成`))}else if("upload_error"===a.type){const e=te.value.find(e=>e.name===a.fileName);e&&(e.status="exception",e.serverToTelegram.status="error"),_.error(`${a.fileName} 传输到Telegram失败: ${a.error}`)}}catch(a){}},oe.value.onerror=e=>{}})()}),o(()=>{window.removeEventListener("paste",ge),oe.value&&(oe.value.close(),oe.value=null)}),(e,a)=>{const l=x,s=C,t=$,o=z,d=b,k=y,_=w,oe=L,ge=B,fe=T;return u(),n("div",I,[r(fe,{gutter:20},{default:i(()=>[r(_,{xs:24,sm:24,md:14,lg:14,xl:14},{default:i(()=>[r(k,{class:"content-card"},{header:i(()=>[c("div",J,[r(l,null,{default:i(()=>[r(p(M))]),_:1}),a[0]||(a[0]=c("span",null,"文件上传",-1))])]),default:i(()=>[r(s,{ref_key:"uploadRef",ref:ee,drag:"",multiple:"",action:"#","auto-upload":!1,"on-change":re,"on-remove":ie,"file-list":ae.value,class:"upload-dragger"},{tip:i(()=>a[1]||(a[1]=[c("div",{class:"el-upload__tip"}," 支持多文件上传，支持 Ctrl+V 粘贴文件。 ",-1)])),default:i(()=>[r(l,{class:"el-icon--upload"},{default:i(()=>[r(p(M))]),_:1}),a[2]||(a[2]=c("div",{class:"el-upload__text"},[v(" 将文件拖到此处, 或 "),c("em",null,"点击选择")],-1))]),_:1,__:[2]},8,["file-list"]),c("div",K,[r(t,{type:"primary",onClick:ue,disabled:se.value||0===ae.value.length,loading:se.value,size:"large",icon:p(j)},{default:i(()=>[v(m(se.value?`正在上传 (${ne.value}/${ae.value.length})`:"开始上传"),1)]),_:1},8,["disabled","loading","icon"])]),r(d,null,{default:i(()=>[te.value.length>0?(u(),n("div",O,[(u(!0),n(f,null,h(te.value,e=>(u(),n("div",{key:e.uid,class:"file-progress-item"},[c("span",P,m(e.name),1),r(o,{percentage:Math.round(100*e.percentage)/100,status:e.status,"stroke-width":8,striped:"","striped-flow":"success"!==e.status&&"exception"!==e.status},null,8,["percentage","status","striped-flow"]),c("div",S,m(me(e.loaded))+" / "+m(me(e.total)),1),"uploading"===e.serverToTelegram.status||"completed"===e.serverToTelegram.status?(u(),n("div",A,[c("div",G,["completed"===e.serverToTelegram.status?(u(),n("span",H,"✅ 已传输到Telegram")):(u(),n("span",R," 传输到Telegram: "+m(e.serverToTelegram.currentChunk||0)+"/"+m(e.serverToTelegram.totalChunks||0)+" 片 ("+m(Math.round(100*e.serverToTelegram.percentage)/100)+"%) ",1))]),r(o,{percentage:Math.round(100*e.serverToTelegram.percentage)/100,status:"completed"===e.serverToTelegram.status?"success":e.status,"stroke-width":8,striped:"","striped-flow":"completed"!==e.serverToTelegram.status&&"exception"!==e.status},null,8,["percentage","status","striped-flow"])])):g("",!0)]))),128))])):g("",!0)]),_:1})]),_:1})]),_:1}),r(_,{xs:24,sm:24,md:10,lg:10,xl:10},{default:i(()=>[r(k,{class:"content-card"},{header:i(()=>[c("div",V,[r(l,null,{default:i(()=>[r(p(U))]),_:1}),a[4]||(a[4]=c("span",null,"本次上传结果",-1)),r(t,{text:"",type:"primary",onClick:de},{default:i(()=>a[3]||(a[3]=[v("查看全部")])),_:1,__:[3]})])]),default:i(()=>[0===le.value.length?(u(),n("div",W,[r(oe,{description:"暂无上传成功的文件"})])):(u(),n("div",q,[(u(!0),n(f,null,h(le.value,e=>(u(),n("div",{key:e.fileId,class:"uploaded-file-item"},[c("div",Q,[r(l,null,{default:i(()=>[r(p(N))]),_:1}),c("span",X,m(e.fileName),1)]),c("div",Y,[r(ge,{content:"复制 Markdown 格式",placement:"top"},{default:i(()=>[r(t,{text:"",circle:"",icon:p(F),onClick:a=>(e=>{ce(`[${e.fileName}](${e.downloadLink})`,"Markdown 格式已复制")})(e)},null,8,["icon","onClick"])]),_:2},1024),r(ge,{content:"复制下载链接",placement:"top"},{default:i(()=>[r(t,{text:"",circle:"",icon:p(D),onClick:a=>(e=>{ce(e.downloadLink,"下载链接已复制")})(e)},null,8,["icon","onClick"])]),_:2},1024),r(ge,{content:"打开/下载文件",placement:"top"},{default:i(()=>[r(t,{text:"",circle:"",icon:p(E),onClick:a=>{return l=e.downloadLink,void window.open(l,"_blank");var l}},null,8,["icon","onClick"])]),_:2},1024)])]))),128))])),le.value.length>0?(u(),n("div",Z,[r(t,{onClick:pe,disabled:0===le.value.length,size:"small",plain:""},{default:i(()=>a[5]||(a[5]=[v("批量复制 (MD)")])),_:1,__:[5]},8,["disabled"]),r(t,{onClick:ve,disabled:0===le.value.length,size:"small",plain:""},{default:i(()=>a[6]||(a[6]=[v("批量复制 (链接)")])),_:1,__:[6]},8,["disabled"])])):g("",!0)]),_:1})]),_:1})]),_:1})])}}}),[["__scopeId","data-v-545cd6c3"]]);export{ee as default};

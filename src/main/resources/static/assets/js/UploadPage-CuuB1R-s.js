import{_ as e}from"./_plugin-vue_export-helper-DvehuVrX.js";/* empty css               */import"./el-tooltip-l0sNRNKZ.js";/* empty css                  *//* empty css                 *//* empty css                */import"./el-collapse-transition-l0sNRNKZ.js";/* empty css                    */import{t as a,c as s,v as t,x as l,A as n,M as o,K as r,r as i,f as u,U as c,E as d,av as p,u as v,J as m,H as f,L as g,a9 as h,D as _,V as k}from"./vue-vendor-BNZdp1ez.js";import{a as w}from"./vendor-JtNx7una.js";import{b as x,c as y,E as C,d as $,e as b,f as j,h as M,u as z,i as L,j as B,k as N,l as D,m as E,n as F,o as I,p as T,v as U,t as P}from"./element-plus-CgPdM7LF.js";const A={class:"file-progress-item"},J={class:"progress-header"},K={class:"file-name"},O={class:"file-size-info"},S={class:"progress-info-text"},V=e(a({__name:"UploadProgressItem",props:{item:{}},setup(e){const a=e,i=s(()=>{const e=a.item;return"success"===e.server.status?100:"uploading"===e.server.status?50+.5*e.server.percentage:"success"===e.client.status?50:"uploading"===e.client.status||"exception"===e.client.status?.5*e.client.percentage:"exception"===e.server.status?50+.5*e.server.percentage:0}),u=s(()=>{const e=a.item;return"exception"===e.client.status||"exception"===e.server.status?"exception":"success"===e.server.status?"success":"uploading"}),c=s(()=>{const e=a.item;return"success"===e.server.status?"✅ 上传完成":"exception"===e.client.status?"❌ 阶段1失败: 上传到服务器时出错":"exception"===e.server.status?"❌ 阶段2失败: 从服务器传输时出错":"uploading"===e.server.status?`阶段2: 传输到Telegram (${e.server.currentChunk}/${e.server.totalChunks}块)`:"success"===e.client.status?"阶段2: 等待传输...":`阶段1: 上传到服务器 (${d(e.client.loaded)})`}),d=e=>{if(0===e)return"0 B";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["B","KB","MB","GB","TB"][a]};return(e,a)=>{const s=x;return l(),t("div",A,[n("div",J,[n("span",K,r(e.item.name),1),n("span",O,r(d(e.item.total)),1)]),o(s,{percentage:i.value,status:u.value,"stroke-width":10,striped:"","striped-flow":"uploading"===u.value,class:"unified-progress-bar"},null,8,["percentage","status","striped-flow"]),n("div",S,[n("span",null,r(c.value),1)])])}}}),[["__scopeId","data-v-04994fe0"]]),q={class:"page-container"},G={class:"card-header"},H={class:"upload-actions"},R={key:0,class:"progress-section"},W={class:"card-header"},Q={key:0,class:"empty-state"},X={key:1,class:"uploaded-files-list"},Y={class:"file-details"},Z={class:"uploaded-file-name"},ee={class:"file-actions"},ae={key:2,class:"batch-actions"},se={class:"batch-button-group"},te=e(a({__name:"UploadPage",setup(e){const a=p(),x=i(),A=i([]),J=i([]),K=i(!1),O=i([]),S=i(null),te=s(()=>O.value.filter(e=>"success"===e.server.status).length),le=(e,a)=>{A.value=a},ne=(e,a)=>{A.value=a},oe=async()=>{var e;if(0!==A.value.length){K.value=!0,J.value=[],O.value=A.value.map(e=>k({uid:e.uid,name:e.name,total:e.size||0,client:{percentage:0,loaded:0,status:"uploading"},server:{percentage:0,currentChunk:0,totalChunks:0,status:"waiting"}}));for(const e of A.value){const s=O.value.find(a=>a.uid===e.uid);if(s)try{const a=new FormData;a.append("file",e.raw);const t=await w.post("/api/upload",a,{timeout:216e5,onUploadProgress:e=>{e.total&&(s.client.loaded=e.loaded,s.client.percentage=e.loaded/e.total*100)}}),{code:l,msg:n,data:o}=t.data;if(1!==l)throw new Error(n||"上传响应错误");s.client.status="success",J.value.push(o)}catch(a){s.client.status="exception",C.error(`${e.name} 上传失败: ${a.message}`)}}K.value=!1,A.value=[],null==(e=x.value)||e.clearFiles()}else C.warning("请先选择文件")},re=()=>a.push("/fileList"),ie=(e,a)=>{navigator.clipboard.writeText(e).then(()=>C.success(a))},ue=()=>{const e=J.value.map(e=>`![${e.fileName}](${e.downloadLink})`).join("\n");ie(e,`已批量复制 ${J.value.length} 个 Markdown 链接`)},ce=()=>{const e=J.value.map(e=>e.downloadLink).join("\n");ie(e,`已批量复制 ${J.value.length} 个下载链接`)},de=e=>{var a;const s=null==(a=e.clipboardData)?void 0:a.items;if(!s)return;const t=[];for(let l=0;l<s.length;l++)if("file"===s[l].kind){const e=s[l].getAsFile();e&&t.push(e)}if(t.length>0){const e=t.map((e,a)=>{const s=Date.now()+a;return{name:e.name,size:e.size,uid:s,raw:Object.assign(e,{uid:s}),status:"ready"}}).filter(e=>!A.value.some(a=>a.name===e.name&&a.size===e.size));e.length>0&&(A.value.push(...e),C.success(`已通过粘贴添加 ${e.length} 个文件`))}};return u(()=>{window.addEventListener("paste",de),(()=>{const e=`${"https:"===window.location.protocol?"wss":"ws"}://${window.location.host}/ws/upload-progress`;S.value=new WebSocket(e),S.value.onmessage=e=>{try{const a=JSON.parse(e.data),s=O.value.find(e=>e.name===a.fileName);if(!s)return;if("upload_progress"===a.type){s.server.status="uploading";const e=a.total_chunks||a.totalChunks,t=a.current_chunk||a.currentChunk;void 0!==e&&(s.server.totalChunks=e),void 0!==t&&(s.server.currentChunk=t),void 0!==a.percentage&&(s.server.percentage=a.percentage)}else"upload_complete"===a.type?(s.server.status="success",s.server.percentage=100):"upload_error"===a.type&&(s.server.status="exception",C.error(`${a.fileName} 传输到Telegram失败: ${a.error}`))}catch(a){}},S.value.onerror=e=>{}})()}),c(()=>{window.removeEventListener("paste",de),S.value&&S.value.close()}),(e,a)=>{const s=M,i=j,u=L,c=N,p=b,k=$,w=D,C=F,S=y;return l(),t("div",q,[o(S,{gutter:20},{default:d(()=>[o(k,{xs:24,sm:24,md:14,lg:14,xl:14},{default:d(()=>[o(p,{class:"content-card"},{header:d(()=>[n("div",G,[o(s,null,{default:d(()=>[o(v(z))]),_:1}),a[0]||(a[0]=n("span",null,"文件上传",-1))])]),default:d(()=>[o(i,{ref_key:"uploadRef",ref:x,drag:"",multiple:"",action:"#","auto-upload":!1,"on-change":le,"on-remove":ne,"file-list":A.value,class:"upload-dragger"},{tip:d(()=>a[1]||(a[1]=[n("div",{class:"el-upload__tip"}," 支持多文件上传，支持 Ctrl+V 粘贴文件。 ",-1)])),default:d(()=>[o(s,{class:"el-icon--upload"},{default:d(()=>[o(v(z))]),_:1}),a[2]||(a[2]=n("div",{class:"el-upload__text"},[m(" 将文件拖到此处, 或 "),n("em",null,"点击选择")],-1))]),_:1,__:[2]},8,["file-list"]),n("div",H,[o(u,{type:"primary",onClick:oe,disabled:K.value||0===A.value.length,loading:K.value,size:"large",icon:v(B)},{default:d(()=>[m(r(K.value?`正在上传 (${te.value}/${A.value.length})`:"开始上传"),1)]),_:1},8,["disabled","loading","icon"])]),o(c,null,{default:d(()=>[O.value.length>0?(l(),t("div",R,[(l(!0),t(g,null,h(O.value,e=>(l(),_(V,{key:e.uid,item:e},null,8,["item"]))),128))])):f("",!0)]),_:1})]),_:1})]),_:1}),o(k,{xs:24,sm:24,md:10,lg:10,xl:10},{default:d(()=>[o(p,{class:"content-card"},{header:d(()=>[n("div",W,[o(s,null,{default:d(()=>[o(v(P))]),_:1}),a[4]||(a[4]=n("span",null,"本次上传结果",-1)),o(u,{text:"",type:"primary",onClick:re},{default:d(()=>a[3]||(a[3]=[m("查看全部",-1)])),_:1,__:[3]})])]),default:d(()=>[0===J.value.length?(l(),t("div",Q,[o(w,{description:"暂无上传成功的文件"})])):(l(),t("div",X,[(l(!0),t(g,null,h(J.value,e=>(l(),t("div",{key:e.fileId,class:"uploaded-file-item"},[n("div",Y,[o(s,null,{default:d(()=>[o(v(E))]),_:1}),n("span",Z,r(e.fileName),1)]),n("div",ee,[o(C,{content:"复制 Markdown 格式",placement:"top"},{default:d(()=>[o(u,{text:"",circle:"",icon:v(I),onClick:a=>(e=>ie(`![${e.fileName}](${e.downloadLink})`,"Markdown 格式已复制"))(e)},null,8,["icon","onClick"])]),_:2},1024),o(C,{content:"复制下载链接",placement:"top"},{default:d(()=>[o(u,{text:"",circle:"",icon:v(T),onClick:a=>(e=>ie(e.downloadLink,"下载链接已复制"))(e)},null,8,["icon","onClick"])]),_:2},1024),o(C,{content:"打开/下载文件",placement:"top"},{default:d(()=>[o(u,{text:"",circle:"",icon:v(U),onClick:a=>{return s=e.downloadLink,window.open(s,"_blank");var s}},null,8,["icon","onClick"])]),_:2},1024)])]))),128))])),J.value.length>0?(l(),t("div",ae,[n("div",se,[o(u,{onClick:ue,disabled:0===J.value.length,size:"small",plain:""},{default:d(()=>a[5]||(a[5]=[m("批量复制 (MD)",-1)])),_:1,__:[5]},8,["disabled"]),o(u,{onClick:ce,disabled:0===J.value.length,size:"small",plain:""},{default:d(()=>a[6]||(a[6]=[m("批量复制 (链接)",-1)])),_:1,__:[6]},8,["disabled"])])])):f("",!0)]),_:1})]),_:1})]),_:1})])}}}),[["__scopeId","data-v-555ecd25"]]);export{te as default};

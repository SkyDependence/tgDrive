import{_ as e}from"./_plugin-vue_export-helper-DvehuVrX.js";/* empty css               */import"./el-tooltip-l0sNRNKZ.js";/* empty css                  *//* empty css                 *//* empty css                */import"./el-collapse-transition-l0sNRNKZ.js";/* empty css                  */import{d as a,r as t,b as l,l as s,U as o,c as n,M as r,E as i,o as u,av as d,a as c,u as p,J as m,K as v,H as g,L as f,a9 as h}from"./vue-vendor-Cc5FuWtX.js";import{a as k}from"./vendor-CdKXy6i5.js";import{a as T,b as _,c as w,d as y,e as C,f as x,u as b,h as M,i as $,j,k as z,l as L,m as N,n as B,o as F,p as D,v as E,t as S}from"./element-plus-D6es4l3D.js";const U={class:"page-container"},I={class:"card-header"},J={class:"upload-actions"},K={key:0,class:"progress-section"},O={class:"file-name"},P={class:"file-size-info"},q={key:0,class:"telegram-info"},A={class:"telegram-progress-text"},G={key:0},H={key:1},R={class:"card-header"},V={key:0,class:"empty-state"},W={key:1,class:"uploaded-files-list"},Q={class:"file-details"},X={class:"uploaded-file-name"},Y={class:"file-actions"},Z={key:2,class:"batch-actions"},ee={class:"batch-button-group"},ae=e(a({__name:"UploadPage",setup(e){const a=d(),ae=t(),te=t([]),le=t([]),se=t(!1),oe=t([]),ne=t(null),re=l(()=>oe.value.filter(e=>"success"===e.status).length),ie=(e,a)=>{te.value=a},ue=(e,a)=>{te.value=a},de=async()=>{var e,a,t;if(0!==te.value.length){se.value=!0,le.value=[],oe.value=te.value.map(e=>({uid:e.uid,name:e.name,percentage:0,status:void 0,loaded:0,total:e.size||0,serverToTelegram:{percentage:0,currentChunk:0,totalChunks:0,status:"waiting"}}));for(const t of te.value){const s=oe.value.find(e=>e.uid===t.uid);if(!s)continue;const o=t.raw;try{const e=new FormData;e.append("file",o);const a=await k.post("/api/upload",e,{timeout:216e5,onUploadProgress:e=>{if(e.total){s.loaded=e.loaded,s.total=e.total;const a=Math.round(e.loaded/e.total*1e4)/100;s.percentage=a}}}),{code:l,msg:n,data:r}=a.data;1===l?(s.serverToTelegram.status="uploading",le.value.push(r)):(s.status="exception",_.error(`${t.name} 上传失败: ${n||"未知错误"}`))}catch(l){s.status="exception";const o=(null==(a=null==(e=l.response)?void 0:e.data)?void 0:a.msg)||l.message||"网络错误";_.error(`${t.name} 上传失败: ${o}`)}}se.value=!1,te.value=[],null==(t=ae.value)||t.clearFiles()}else _.warning("请先选择文件")},ce=()=>{a.push("/fileList")},pe=(e,a)=>{navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{_.success(a)}).catch(t=>{me(e,a)}):me(e,a)},me=(e,a)=>{const t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy")?_.success(a):_.error("复制失败，请手动复制")}catch(l){_.error("复制失败，请手动复制")}document.body.removeChild(t)},ve=()=>{const e=le.value.map(e=>`[${e.fileName}](${e.downloadLink})`).join("\n");pe(e,`已批量复制 ${le.value.length} 个 Markdown 链接`)},ge=()=>{const e=le.value.map(e=>e.downloadLink).join("\n");pe(e,`已批量复制 ${le.value.length} 个下载链接`)},fe=e=>{if(0===e)return"0 B";const a=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,a)).toFixed(2))+" "+["B","KB","MB","GB","TB"][a]},he=e=>{var a;const t=null==(a=e.clipboardData)?void 0:a.items;if(t){for(let e=0;e<t.length;e++)if("file"===t[e].kind){const a=t[e].getAsFile();if(a){const t=Date.now()+e,l={name:a.name,size:a.size,uid:t,raw:Object.assign(a,{uid:t}),status:"ready"};te.value.some(e=>e.name===l.name&&e.size===l.size)||te.value.push(l)}}te.value.length>0&&_.success("已通过粘贴添加文件")}};return s(()=>{window.addEventListener("paste",he),(()=>{const e=`ws://${window.location.host}/ws/upload-progress`;ne.value=new WebSocket(e),ne.value.onmessage=e=>{try{const a=JSON.parse(e.data);if("upload_progress"===a.type){const e=oe.value.find(e=>e.name===a.fileName);e&&"completed"!==e.serverToTelegram.status&&("waiting"===e.serverToTelegram.status&&(e.serverToTelegram.status="uploading"),e.serverToTelegram.percentage=Math.round(100*a.percentage)/100,void 0!==a.currentChunk&&(e.serverToTelegram.currentChunk=a.currentChunk),void 0!==a.totalChunks&&(e.serverToTelegram.totalChunks=a.totalChunks),e.percentage=Math.round(100*a.percentage)/100)}else if("upload_complete"===a.type){const e=oe.value.find(e=>e.name===a.fileName);e&&(e.serverToTelegram.status="completed",e.serverToTelegram.percentage=100,e.status="success",e.percentage=100,_.success(`${a.fileName} 完全上传完成`))}else if("upload_error"===a.type){const e=oe.value.find(e=>e.name===a.fileName);e&&(e.status="exception",e.serverToTelegram.status="error"),_.error(`${a.fileName} 传输到Telegram失败: ${a.error}`)}}catch(a){}},ne.value.onerror=e=>{}})()}),o(()=>{window.removeEventListener("paste",he),ne.value&&(ne.value.close(),ne.value=null)}),(e,a)=>{const t=x,l=C,s=M,o=z,d=j,k=y,_=w,ne=L,me=B,he=T;return u(),n("div",U,[r(he,{gutter:20},{default:i(()=>[r(_,{xs:24,sm:24,md:14,lg:14,xl:14},{default:i(()=>[r(k,{class:"content-card"},{header:i(()=>[c("div",I,[r(t,null,{default:i(()=>[r(p(b))]),_:1}),a[0]||(a[0]=c("span",null,"文件上传",-1))])]),default:i(()=>[r(l,{ref_key:"uploadRef",ref:ae,drag:"",multiple:"",action:"#","auto-upload":!1,"on-change":ie,"on-remove":ue,"file-list":te.value,class:"upload-dragger"},{tip:i(()=>a[1]||(a[1]=[c("div",{class:"el-upload__tip"}," 支持多文件上传，支持 Ctrl+V 粘贴文件。 ",-1)])),default:i(()=>[r(t,{class:"el-icon--upload"},{default:i(()=>[r(p(b))]),_:1}),a[2]||(a[2]=c("div",{class:"el-upload__text"},[m(" 将文件拖到此处, 或 "),c("em",null,"点击选择")],-1))]),_:1,__:[2]},8,["file-list"]),c("div",J,[r(s,{type:"primary",onClick:de,disabled:se.value||0===te.value.length,loading:se.value,size:"large",icon:p($)},{default:i(()=>[m(v(se.value?`正在上传 (${re.value}/${te.value.length})`:"开始上传"),1)]),_:1},8,["disabled","loading","icon"])]),r(d,null,{default:i(()=>[oe.value.length>0?(u(),n("div",K,[(u(!0),n(f,null,h(oe.value,e=>(u(),n("div",{key:e.uid,class:"file-progress-item"},[c("span",O,v(e.name),1),r(o,{percentage:Math.round(100*e.percentage)/100,status:e.status,"stroke-width":8,striped:"","striped-flow":"success"!==e.status&&"exception"!==e.status},null,8,["percentage","status","striped-flow"]),c("div",P,v(fe(e.loaded))+" / "+v(fe(e.total)),1),"uploading"===e.serverToTelegram.status||"completed"===e.serverToTelegram.status?(u(),n("div",q,[c("div",A,["completed"===e.serverToTelegram.status?(u(),n("span",G,"✅ 已传输到Telegram")):(u(),n("span",H," 传输到Telegram: "+v(e.serverToTelegram.currentChunk||0)+"/"+v(e.serverToTelegram.totalChunks||0)+" 片 ("+v(Math.round(100*e.serverToTelegram.percentage)/100)+"%) ",1))]),r(o,{percentage:Math.round(100*e.serverToTelegram.percentage)/100,status:"completed"===e.serverToTelegram.status?"success":e.status,"stroke-width":8,striped:"","striped-flow":"completed"!==e.serverToTelegram.status&&"exception"!==e.status},null,8,["percentage","status","striped-flow"])])):g("",!0)]))),128))])):g("",!0)]),_:1})]),_:1})]),_:1}),r(_,{xs:24,sm:24,md:10,lg:10,xl:10},{default:i(()=>[r(k,{class:"content-card"},{header:i(()=>[c("div",R,[r(t,null,{default:i(()=>[r(p(S))]),_:1}),a[4]||(a[4]=c("span",null,"本次上传结果",-1)),r(s,{text:"",type:"primary",onClick:ce},{default:i(()=>a[3]||(a[3]=[m("查看全部",-1)])),_:1,__:[3]})])]),default:i(()=>[0===le.value.length?(u(),n("div",V,[r(ne,{description:"暂无上传成功的文件"})])):(u(),n("div",W,[(u(!0),n(f,null,h(le.value,e=>(u(),n("div",{key:e.fileId,class:"uploaded-file-item"},[c("div",Q,[r(t,null,{default:i(()=>[r(p(N))]),_:1}),c("span",X,v(e.fileName),1)]),c("div",Y,[r(me,{content:"复制 Markdown 格式",placement:"top"},{default:i(()=>[r(s,{text:"",circle:"",icon:p(F),onClick:a=>(e=>{pe(`[${e.fileName}](${e.downloadLink})`,"Markdown 格式已复制")})(e)},null,8,["icon","onClick"])]),_:2},1024),r(me,{content:"复制下载链接",placement:"top"},{default:i(()=>[r(s,{text:"",circle:"",icon:p(D),onClick:a=>(e=>{pe(e.downloadLink,"下载链接已复制")})(e)},null,8,["icon","onClick"])]),_:2},1024),r(me,{content:"打开/下载文件",placement:"top"},{default:i(()=>[r(s,{text:"",circle:"",icon:p(E),onClick:a=>{return t=e.downloadLink,void window.open(t,"_blank");var t}},null,8,["icon","onClick"])]),_:2},1024)])]))),128))])),le.value.length>0?(u(),n("div",Z,[c("div",ee,[r(s,{onClick:ve,disabled:0===le.value.length,size:"small",plain:""},{default:i(()=>a[5]||(a[5]=[m("批量复制 (MD)",-1)])),_:1,__:[5]},8,["disabled"]),r(s,{onClick:ge,disabled:0===le.value.length,size:"small",plain:""},{default:i(()=>a[6]||(a[6]=[m("批量复制 (链接)",-1)])),_:1,__:[6]},8,["disabled"])])])):g("",!0)]),_:1})]),_:1})]),_:1})])}}}),[["__scopeId","data-v-75250363"]]);export{ae as default};

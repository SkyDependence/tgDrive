import{_ as e}from"./_plugin-vue_export-helper-DvehuVrX.js";/* empty css                        *//* empty css               *//* empty css                  *//* empty css                     *//* empty css                  *//* empty css                   *//* empty css                     *//* empty css                *//* empty css                 *//* empty css                    */import"./el-tooltip-l0sNRNKZ.js";/* empty css                        *//* empty css                  *//* empty css                 */import{t as a,r as l,c as s,f as t,U as o,v as r,M as i,E as n,A as d,F as u,H as c,u as v,K as m,D as p,J as w,L as f,a9 as g,aj as _,x as y}from"./vue-vendor-BNZdp1ez.js";import{e as h,I as b,E as k,aG as V,h as C,_ as j,N as x,O as P,a7 as R,P as U,i as z,ay as L,R as T,S as E,T as q,l as B,s as F,W as I,X as $,q as A,r as D,A as M,H as G,G as H}from"./element-plus-CgPdM7LF.js";import{s as K}from"./index-DrHwzDkJ.js";import"./vendor-JtNx7una.js";const S={class:"page-container"},W={class:"card-header"},J={class:"header-left"},N={class:"header-right"},O={class:"search-button-group"},X={class:"settings-container"},Q={class:"setting-item"},Y={class:"stats-container"},Z={class:"stat-card"},ee={class:"stat-icon total-users"},ae={class:"stat-content"},le={class:"stat-number"},se={class:"stat-card"},te={class:"stat-icon online-users"},oe={class:"stat-content"},re={class:"stat-number"},ie={class:"stat-card"},ne={class:"stat-icon admin-users"},de={class:"stat-content"},ue={class:"stat-number"},ce={style:{display:"flex","align-items":"center",gap:"8px"}},ve={key:1,class:"mobile-user-list"},me={key:2},pe={class:"user-info"},we={class:"user-details"},fe={class:"user-name"},ge={class:"user-meta"},_e={class:"user-email"},ye={class:"user-login-time"},he={class:"user-actions"},be={class:"dialog-footer"},ke={class:"dialog-footer"},Ve=e(a({__name:"UserManagement",setup(e){const a=l([]),Ve=l(!1),Ce=l(""),je=l(!1),xe=l(!1),Pe=l(!1),Re=l(),Ue=l(!1),ze=l(!1),Le=l(),Te=l(null),Ee=l(0),qe=l(0),Be=l(0),Fe=l(!1),Ie=l(!1),$e=l({username:"",newPassword:"",confirmPassword:""}),Ae=l({username:"",currentRole:"",newRole:""}),De={newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度至少为6位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认密码",trigger:"blur"},{validator:(e,a,l)=>{a!==$e.value.newPassword?l(new Error("两次输入的密码不一致")):l()},trigger:"blur"}]},Me={newRole:[{required:!0,message:"请选择新角色",trigger:"change"}]},Ge=s(()=>Ce.value&&a.value?a.value.filter(e=>{var a,l;return(null==(a=e.username)?void 0:a.toLowerCase().includes(Ce.value.toLowerCase()))||(null==(l=e.email)?void 0:l.toLowerCase().includes(Ce.value.toLowerCase()))}):a.value||[]),He=()=>{je.value=window.innerWidth<768},Ke=e=>{switch(e){case"admin":return"danger";case"user":return"success";case"visitor":return"info";default:return""}},Se=e=>{switch(e){case"admin":return"管理员";case"user":return"用户";case"visitor":return"访客";default:return e}},We=async()=>{var e,l;Ve.value=!0;try{const s=await K.get("/auth/admin/users");1===(null==(e=s.data)?void 0:e.code)?(a.value=s.data.data||[],Ne()):k.error((null==(l=s.data)?void 0:l.msg)||"获取用户列表失败")}catch(s){k.error("获取用户列表失败，请检查网络连接")}finally{Ve.value=!1}},Je=async e=>{var a,l;Ie.value=!0;try{const s=await K.post("/setting",{key:"allow_registration",value:e.toString()});1===(null==(a=s.data)?void 0:a.code)?k.success("设置更新成功"):(k.error((null==(l=s.data)?void 0:l.msg)||"设置更新失败"),Fe.value=!e)}catch(s){k.error("设置更新失败，请检查网络连接"),Fe.value=!e}finally{Ie.value=!1}},Ne=()=>{Ee.value=a.value.length,Be.value=a.value.filter(e=>"admin"===e.role).length,qe.value=Math.floor(.1*Ee.value)},Oe=()=>{},Xe=()=>{Ce.value="",We()},Qe=e=>{Te.value=e,$e.value={username:e.username,newPassword:"",confirmPassword:""},xe.value=!0},Ye=async()=>{var e,a,l,s;if(Re.value)try{await Re.value.validate(),Pe.value=!0;const l=await K.post("/auth/admin/change-password",{username:$e.value.username,newPassword:$e.value.newPassword});1===(null==(e=l.data)?void 0:e.code)?(k.success("密码修改成功"),xe.value=!1):k.error((null==(a=l.data)?void 0:a.msg)||"密码修改失败")}catch(t){"validation failed"!==t&&k.error("密码修改失败: "+((null==(s=null==(l=t.response)?void 0:l.data)?void 0:s.msg)||t.message))}finally{Pe.value=!1}},Ze=e=>{Te.value=e,Ae.value={username:e.username,currentRole:e.role,newRole:e.role},Ue.value=!0},ea=async()=>{var e,a,l,s,t;if(Le.value)try{if(await Le.value.validate(),Ae.value.newRole===Ae.value.currentRole)return void k.warning("新角色与当前角色相同");ze.value=!0;const s=await K.put(`/auth/admin/users/${null==(e=Te.value)?void 0:e.id}/role?role=${Ae.value.newRole}`);1===(null==(a=s.data)?void 0:a.code)?(k.success("用户角色设置成功"),Ue.value=!1,We()):k.error((null==(l=s.data)?void 0:l.msg)||"角色设置失败")}catch(o){"validation failed"!==o&&k.error("角色设置失败: "+((null==(t=null==(s=o.response)?void 0:s.data)?void 0:t.msg)||o.message))}finally{ze.value=!1}},aa=async e=>{var a,l,s,t;if("admin"!==e.role)try{await H.confirm(`确定要删除用户 "${e.username}" 吗？此操作不可撤销。`,"删除确认",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",confirmButtonClass:"el-button--danger"});const s=await K.delete(`/auth/admin/users/${e.id}`);1===(null==(a=s.data)?void 0:a.code)?(k.success("用户删除成功"),We()):k.error((null==(l=s.data)?void 0:l.msg)||"删除失败")}catch(o){"cancel"!==o&&k.error("删除用户失败: "+((null==(t=null==(s=o.response)?void 0:s.data)?void 0:t.msg)||o.message))}else k.warning("不能删除管理员账户")};return t(()=>{He(),window.addEventListener("resize",He),We(),(async()=>{var e,a;try{const l=await K.get("/setting/settings");if(1===(null==(e=l.data)?void 0:e.code)){const e=l.data.data.find(e=>"allow_registration"===e.key);e&&(Fe.value="true"===e.value)}else k.error((null==(a=l.data)?void 0:a.msg)||"获取系统设置失败")}catch(l){k.error("获取系统设置失败，请检查网络连接")}})()}),o(()=>{window.removeEventListener("resize",He)}),(e,a)=>{const l=C,s=F,t=z,o=V,k=P,H=R,K=U,Te=E,He=q,We=B,Ne=h,la=D,sa=A,ta=b,oa=G,ra=M,ia=x;return y(),r("div",S,[i(Ne,{class:"content-card"},{header:n(()=>[d("div",W,[d("div",J,[i(l,null,{default:n(()=>[i(v(j))]),_:1}),a[11]||(a[11]=d("span",null,"用户管理",-1))]),d("div",N,[i(s,{modelValue:Ce.value,"onUpdate:modelValue":a[0]||(a[0]=e=>Ce.value=e),placeholder:"搜索用户名或邮箱",clearable:"",style:{width:"200px","margin-right":"10px"},onKeyup:_(Oe,["enter"])},null,8,["modelValue"]),d("div",O,[i(t,{type:"primary",onClick:Oe,icon:v(I)},{default:n(()=>a[12]||(a[12]=[w("搜索",-1)])),_:1,__:[12]},8,["icon"]),i(t,{type:"default",onClick:Xe,icon:v($)},{default:n(()=>a[13]||(a[13]=[w("刷新",-1)])),_:1,__:[13]},8,["icon"])])])])]),default:n(()=>[d("div",X,[d("div",Q,[a[14]||(a[14]=d("span",{class:"setting-label"},"允许用户注册",-1)),i(o,{modelValue:Fe.value,"onUpdate:modelValue":a[1]||(a[1]=e=>Fe.value=e),onChange:Je,loading:Ie.value},null,8,["modelValue","loading"])])]),d("div",Y,[d("div",Z,[d("div",ee,[i(l,null,{default:n(()=>[i(v(j))]),_:1})]),d("div",ae,[d("div",le,m(Ee.value),1),a[15]||(a[15]=d("div",{class:"stat-label"},"总用户数",-1))])]),d("div",se,[d("div",te,[i(l,null,{default:n(()=>[i(v(j))]),_:1})]),d("div",oe,[d("div",re,m(qe.value),1),a[16]||(a[16]=d("div",{class:"stat-label"},"在线用户",-1))])]),d("div",ie,[d("div",ne,[i(l,null,{default:n(()=>[i(v(j))]),_:1})]),d("div",de,[d("div",ue,m(Be.value),1),a[17]||(a[17]=d("div",{class:"stat-label"},"管理员",-1))])])]),je.value?c("",!0):u((y(),p(Te,{key:0,data:Ge.value,height:"calc(100vh - 280px)",style:{width:"100%"}},{default:n(()=>[i(k,{prop:"id",label:"用户ID",width:"80",align:"center"}),i(k,{prop:"username",label:"用户名","min-width":"150","show-overflow-tooltip":""},{default:n(e=>[d("div",ce,[i(l,null,{default:n(()=>[i(v(j))]),_:1}),d("span",null,m(e.row.username),1)])]),_:1}),i(k,{prop:"email",label:"邮箱","min-width":"200","show-overflow-tooltip":""},{default:n(e=>[w(m("admin"===e.row.role?e.row.email||"":e.row.email),1)]),_:1}),i(k,{prop:"role",label:"角色",width:"100",align:"center"},{default:n(e=>[i(H,{type:Ke(e.row.role)},{default:n(()=>[w(m(Se(e.row.role)),1)]),_:2},1032,["type"])]),_:1}),i(k,{prop:"lastLoginTime",label:"最后上线时间",width:"180",align:"center"},{default:n(e=>[w(m(e.row.lastLoginTime||"从未登录"),1)]),_:1}),i(k,{label:"操作",width:"280",align:"center",fixed:"right"},{default:n(e=>[i(K,null,{default:n(()=>[i(t,{type:"primary",size:"small",onClick:a=>Ze(e.row),icon:v(j),disabled:"visitor"===e.row.username},{default:n(()=>a[18]||(a[18]=[w(" 设角色 ",-1)])),_:2,__:[18]},1032,["onClick","icon","disabled"]),i(t,{type:"warning",size:"small",onClick:a=>Qe(e.row),icon:v(L),disabled:"visitor"===e.row.username},{default:n(()=>a[19]||(a[19]=[w(" 改密 ",-1)])),_:2,__:[19]},1032,["onClick","icon","disabled"]),i(t,{type:"danger",size:"small",onClick:a=>aa(e.row),icon:v(T),disabled:"admin"===e.row.role||"visitor"===e.row.username},{default:n(()=>a[20]||(a[20]=[w(" 删除 ",-1)])),_:2,__:[20]},1032,["onClick","icon","disabled"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[ia,Ve.value]]),je.value?(y(),r("div",ve,[Ve.value?(y(),p(He,{key:0,rows:5,animated:""})):0===Ge.value.length?(y(),p(We,{key:1,description:"暂无用户"})):(y(),r("div",me,[(y(!0),r(f,null,g(Ge.value,e=>(y(),r("div",{key:e.id,class:"mobile-user-item"},[d("div",pe,[i(l,{class:"user-icon"},{default:n(()=>[i(v(j))]),_:1}),d("div",we,[d("div",fe,m(e.username),1),d("div",ge,[d("span",null,"ID: "+m(e.id),1),i(H,{type:Ke(e.role),size:"small"},{default:n(()=>[w(m(Se(e.role)),1)]),_:2},1032,["type"])]),d("div",_e,m(e.email),1),d("div",ye,"最后上线: "+m(e.lastLoginTime||"从未登录"),1)])]),d("div",he,[i(K,null,{default:n(()=>[i(t,{type:"primary",size:"small",onClick:a=>Ze(e),icon:v(j),disabled:"visitor"===e.username},{default:n(()=>a[21]||(a[21]=[w(" 设角色 ",-1)])),_:2,__:[21]},1032,["onClick","icon","disabled"]),i(t,{type:"warning",size:"small",onClick:a=>Qe(e),icon:v(L),disabled:"visitor"===e.username},{default:n(()=>a[22]||(a[22]=[w(" 改密 ",-1)])),_:2,__:[22]},1032,["onClick","icon","disabled"]),i(t,{type:"danger",size:"small",onClick:a=>aa(e),icon:v(T),disabled:"admin"===e.role||"visitor"===e.username},{default:n(()=>a[23]||(a[23]=[w(" 删除 ",-1)])),_:2,__:[23]},1032,["onClick","icon","disabled"])]),_:2},1024)])]))),128))]))])):c("",!0)]),_:1}),i(ta,{modelValue:xe.value,"onUpdate:modelValue":a[6]||(a[6]=e=>xe.value=e),title:"修改用户密码",width:"400px","close-on-click-modal":!1},{footer:n(()=>[d("span",be,[i(t,{onClick:a[5]||(a[5]=e=>xe.value=!1)},{default:n(()=>a[24]||(a[24]=[w("取消",-1)])),_:1,__:[24]}),i(t,{type:"primary",onClick:Ye,loading:Pe.value},{default:n(()=>a[25]||(a[25]=[w(" 确定 ",-1)])),_:1,__:[25]},8,["loading"])])]),default:n(()=>[i(sa,{ref_key:"changePasswordFormRef",ref:Re,model:$e.value,rules:De,"label-width":"100px"},{default:n(()=>[i(la,{label:"用户名"},{default:n(()=>[i(s,{modelValue:$e.value.username,"onUpdate:modelValue":a[2]||(a[2]=e=>$e.value.username=e),disabled:""},null,8,["modelValue"])]),_:1}),i(la,{label:"新密码",prop:"newPassword"},{default:n(()=>[i(s,{modelValue:$e.value.newPassword,"onUpdate:modelValue":a[3]||(a[3]=e=>$e.value.newPassword=e),type:"password",placeholder:"请输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),i(la,{label:"确认密码",prop:"confirmPassword"},{default:n(()=>[i(s,{modelValue:$e.value.confirmPassword,"onUpdate:modelValue":a[4]||(a[4]=e=>$e.value.confirmPassword=e),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),i(ta,{modelValue:Ue.value,"onUpdate:modelValue":a[10]||(a[10]=e=>Ue.value=e),title:"设置用户角色",width:"400px","close-on-click-modal":!1},{footer:n(()=>[d("span",ke,[i(t,{onClick:a[9]||(a[9]=e=>Ue.value=!1)},{default:n(()=>a[26]||(a[26]=[w("取消",-1)])),_:1,__:[26]}),i(t,{type:"primary",onClick:ea,loading:ze.value},{default:n(()=>a[27]||(a[27]=[w(" 确定 ",-1)])),_:1,__:[27]},8,["loading"])])]),default:n(()=>[i(sa,{ref_key:"setRoleFormRef",ref:Le,model:Ae.value,rules:Me,"label-width":"100px"},{default:n(()=>[i(la,{label:"用户名"},{default:n(()=>[i(s,{modelValue:Ae.value.username,"onUpdate:modelValue":a[7]||(a[7]=e=>Ae.value.username=e),disabled:""},null,8,["modelValue"])]),_:1}),i(la,{label:"当前角色"},{default:n(()=>[i(H,{type:Ke(Ae.value.currentRole)},{default:n(()=>[w(m(Se(Ae.value.currentRole)),1)]),_:1},8,["type"])]),_:1}),i(la,{label:"新角色",prop:"newRole"},{default:n(()=>[i(ra,{modelValue:Ae.value.newRole,"onUpdate:modelValue":a[8]||(a[8]=e=>Ae.value.newRole=e),placeholder:"请选择新角色",style:{width:"100%"}},{default:n(()=>[i(oa,{label:"管理员",value:"admin"}),i(oa,{label:"普通用户",value:"user"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-540c7d1c"]]);export{Ve as default};
